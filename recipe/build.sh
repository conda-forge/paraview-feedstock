#!/bin/sh

export LDFLAGS="$LDFLAGS -Wl,-rpath-link,$PREFIX/lib"

# do not build plugins
rm -r ./Plugins/*

mkdir build && cd build

cmake \
  -DCMAKE_INSTALL_PREFIX=${PREFIX} \
  -DCMAKE_PREFIX_PATH=${PREFIX} \
  -DCMAKE_INSTALL_RPATH:STRING=${PREFIX}/lib \
  -DVTK_INSTALL_LIBRARY_DIR="lib" \
  -DBUILD_SHARED_LIBS=ON \
  -DCMAKE_BUILD_TYPE=Release \
  -DBUILD_TESTING:BOOL=OFF \
  -DBUILD_DOCUMENTATION:BOOL=OFF \
  -DBUILD_EXAMPLES:BOOL=OFF \
  -DPARAVIEW_BUILD_QT_GUI:BOOL=OFF \
  -DPARAVIEW_INSTALL_DEVELOPMENT_FILES:BOOL=ON \
  -DPARAVIEW_ENABLE_CATALYST:BOOL=OFF \
  -DPARAVIEW_ENABLE_PYTHON:BOOL=ON \
  -DPYTHON_EXECUTABLE=${PYTHON} \
  -DVTK_PYTHON_SITE_PACKAGES_SUFFIX=python${PY_VER}/site-packages \
  -DPARAVIEW_ENABLE_WEB:BOOL=ON \
  -DVTK_USE_X:BOOL=OFF \
  -VTK_DEFAULT_RENDER_WINDOW_OFFSCREEN=ON \
  -DVTK_USE_SYSTEM_LIBRARIES:BOOL=ON \
  -DVTK_USE_SYSTEM_PUGIXML:BOOL=OFF \
  -DVTK_USE_SYSTEM_AUTOBAHN:BOOL=OFF \
  -DVTK_USE_SYSTEM_GL2PS:BOOL=OFF \
  -DVTK_USE_SYSTEM_LIBHARU:BOOL=OFF \
  -DVTK_USE_SYSTEM_NETCDFCPP:BOOL=OFF \
  -DVTK_USE_SYSTEM_XDMF2=OFF \
  -DVTK_USE_SYSTEM_CGNS=OFF \
  -DVTK_USE_SYSTEM_JSONCPP=OFF \
  -DVTK_OPENGL_HAS_OSMESA:BOOL=ON \
  -DOSMESA_LIBRARY=${PREFIX}/lib/libOSMesa32.so \
  ..
make -j${CPU_COUNT}

# log hits limit
make install > /dev/null

