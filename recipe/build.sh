#!/bin/sh

export LDFLAGS="$LDFLAGS -Wl,-rpath-link,$PREFIX/lib"

# do not build plugins
rm -r ./Plugins/*

mkdir build && cd build

cmake \
  -DCMAKE_INSTALL_PREFIX=${PREFIX} \
  -DCMAKE_PREFIX_PATH=${PREFIX} \
  -DCMAKE_INSTALL_RPATH:STRING=${PREFIX}/lib \
  -DVTK_INSTALL_LIBRARY_DIR="lib" \
  -DBUILD_SHARED_LIBS=ON \
  -DCMAKE_BUILD_TYPE=Release \
  -DBUILD_TESTING:BOOL=OFF \
  -DBUILD_DOCUMENTATION:BOOL=OFF \
  -DBUILD_EXAMPLES:BOOL=OFF \
  -DPARAVIEW_BUILD_QT_GUI:BOOL=OFF \
  -DPARAVIEW_INSTALL_DEVELOPMENT_FILES:BOOL=ON \
  -DPARAVIEW_ENABLE_PYTHON=ON \
  -DPARAVIEW_ENABLE_WEB:BOOL=ON \
  -DVTK_USE_X:BOOL=OFF \
  -DVTK_DEFAULT_RENDER_WINDOW_OFFSCREEN=ON \
  -DVTK_USE_SYSTEM_LIBRARIES:BOOL=ON \
  -DVTK_USE_SYSTEM_GL2PS:BOOL=OFF \
  -DVTK_USE_SYSTEM_NETCDFCPP:BOOL=OFF \
  -DVTK_USE_SYSTEM_XDMF2=OFF \
  -DVTK_USE_SYSTEM_CGNS=OFF \
  -DVTK_USE_SYSTEM_JSONCPP=OFF \
  -DVTK_USE_SYSTEM_PEGTL=OFF \
  -DVTK_OPENGL_HAS_OSMESA:BOOL=ON \
  -DOSMESA_LIBRARY=${PREFIX}/lib/libOSMesa32.so \
  -DCMAKE_RULE_MESSAGES=OFF \
  -DPYTHON_INCLUDE_DIR=$(${PYTHON} -c "from distutils.sysconfig import get_python_inc; print(get_python_inc())")  \
  -DPYTHON_LIBRARY=$(${PYTHON} -c "import distutils.sysconfig as sysconfig; print(sysconfig.get_config_var('LIBDIR'))") \
  ..
make install -j1 VERBOSE=1 #${CPU_COUNT}
